services:
  ferrotunnel-server:
    build: .
    image: ferrotunnel:latest
    ports:
      - "${FERROTUNNEL_HTTP_PORT:-8080}:${FERROTUNNEL_HTTP_PORT:-8080}"  # HTTP Ingress
      - "${FERROTUNNEL_METRICS_PORT:-9090}:${FERROTUNNEL_METRICS_PORT:-9090}"  # Prometheus Metrics
    environment:
      - RUST_LOG=info,ferrotunnel=debug
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      - FERROTUNNEL_HTTP_BIND=0.0.0.0:${FERROTUNNEL_HTTP_PORT:-8080}
      - FERROTUNNEL_METRICS_BIND=0.0.0.0:${FERROTUNNEL_METRICS_PORT:-9090}
      - FERROTUNNEL_METRICS=true
      - FERROTUNNEL_TOKEN=${FERROTUNNEL_TOKEN:-secret-token}
    command: ["server"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FERROTUNNEL_HTTP_PORT:-8080}/health"]
      interval: 10s
      timeout: 10s
      retries: 3

  ferrotunnel-client:
    build: .
    image: ferrotunnel:latest
    depends_on:
      - ferrotunnel-server
      - demo-app
    ports:
      - "${FERROTUNNEL_DASHBOARD_PORT:-4040}:${FERROTUNNEL_DASHBOARD_PORT:-4040}"
    environment:
      - RUST_LOG=info
      - FERROTUNNEL_DASHBOARD_PORT=${FERROTUNNEL_DASHBOARD_PORT:-4040}
    command: >
      client
      --server ferrotunnel-server:7835
      --token ${FERROTUNNEL_TOKEN:-secret-token}
      --local-addr demo-app:80
      --dashboard-port ${FERROTUNNEL_DASHBOARD_PORT:-4040}
    restart: unless-stopped

  demo-app:
    image: nginx:alpine
    restart: unless-stopped
